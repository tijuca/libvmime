From: Carsten Schoenert <c.schoenert@t-online.de>
Date: Sat, 25 Apr 2015 13:11:37 +0200
Subject: mixed qp in parameter::parse

---
 src/parameter.cpp | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/src/parameter.cpp b/src/parameter.cpp
index 91a7e5c..fb94e29 100644
--- a/src/parameter.cpp
+++ b/src/parameter.cpp
@@ -239,8 +239,20 @@ void parameter::parse(const std::vector <valueChunk>& chunks)
 			{
 				value << t.getWholeBuffer();
 
-				if (!foundCharsetChunk)
-					ch = t.getWordAt(0)->getCharset();
+				if (!foundCharsetChunk) {
+					// this is still wrong. each word can have it's
+					// own charset, and can be mixed (eg. iso-8859-1
+					// and iso-2022-jp), but very unlikely.
+					// real fix is to have parameters store a
+					// vmime::text in stead of a vmime::word in
+					// m_value.  but that changes the interface
+					for (size_t i = 0; i < t.getWordCount(); i++) {
+						if (t.getWordAt(i)->getCharset() != ch && ch == charsets::US_ASCII) {
+							ch = t.getWordAt(i)->getCharset();
+							break;
+						}
+					}
+				}
 			}
 		}
 	}
